create database country_db;

use country_db;

create external table country_info(
	country_code string,
	short_name string,
	table_name string,
	long_name string,
	two_alpha_code string,
	currency_unit string,
	special_notes string,
	region string,
	income_group string,
	wb_two_code string,
	national_accounts_base_year string,
	national_accounts_reference_year string,
	sna_price_valuation string,
	lending_category string,
	other_groups string,
	system_of_national_accounts string,
	alternative_conversion_factor string,
	ppp_survey_year string,
	balance_of_payments_manual_in_use string,
	external_debt_reporting_status string,
	system_of_trade string,
	government_accounting_concept string,
	imf_data_dissemination_standard string,
	latest_population_census string,
	latest_household_survey string,
	source_of_most_recent_income_and_expenditure_data string,
	vital_registration_complete string,
	latest_agricultural_census string,
	latest_industrial_data int,
	latest_trade_data int,
	latest_water_withdrawal_data int)
	row format serde 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
	with serdeproperties(
		"separatorChar" = ",",
		"quoteChar"     = "\""
	)
	stored as textfile
	location '/user/cloudera/loadData'
	tblproperties("skip.header.line.count"="1");
	
load data local inpath '/home/cloudera/data/genderStatsData/Gender_StatsCountry.csv' overwrite into table country_info;

--load the flat file
create external table country_gender(
	country_name string,
	country_code string,
	indicator_name string,
	indicator_code string,
	Y1960 decimal(30, 15),
	Y1961 decimal(30, 15),
	Y1962 decimal(30, 15),
	Y1963 decimal(30, 15),
	Y1964 decimal(30, 15),
	Y1965 decimal(30, 15),
	Y1966 decimal(30, 15),
	Y1967 decimal(30, 15),
	Y1968 decimal(30, 15),
	Y1969 decimal(30, 15),
	Y1970 decimal(30, 15),
	Y1971 decimal(30, 15),
	Y1972 decimal(30, 15),
	Y1973 decimal(30, 15),
	Y1974 decimal(30, 15),
	Y1975 decimal(30, 15),
	Y1976 decimal(30, 15),
	Y1977 decimal(30, 15),
	Y1978 decimal(30, 15),
	Y1979 decimal(30, 15),
	Y1980 decimal(30, 15),
	Y1981 decimal(30, 15),
	Y1982 decimal(30, 15),
	Y1983 decimal(30, 15),
	Y1984 decimal(30, 15),
	Y1985 decimal(30, 15),
	Y1986 decimal(30, 15),
	Y1987 decimal(30, 15),
	Y1988 decimal(30, 15),
	Y1989 decimal(30, 15),
	Y1990 decimal(30, 15),
	Y1991 decimal(30, 15),
	Y1992 decimal(30, 15),
	Y1993 decimal(30, 15),
	Y1994 decimal(30, 15),
	Y1995 decimal(30, 15),
	Y1996 decimal(30, 15),
	Y1997 decimal(30, 15),
	Y1998 decimal(30, 15),
	Y1999 decimal(30, 15),
	Y2000 decimal(30, 15),
	Y2001 decimal(30, 15),
	Y2002 decimal(30, 15),
	Y2003 decimal(30, 15),
	Y2004 decimal(30, 15),
	Y2005 decimal(30, 15),
	Y2006 decimal(30, 15),
	Y2007 decimal(30, 15),
	Y2008 decimal(30, 15),
	Y2009 decimal(30, 15),
	Y2010 decimal(30, 15),
	Y2011 decimal(30, 15),
	Y2012 decimal(30, 15),
	Y2013 decimal(30, 15),
	Y2014 decimal(30, 15),
	Y2015 decimal(30, 15),
	Y2016 decimal(30, 15))
	row format serde 'org.apache.hadoop.hive.serde2.OpenCSVSerde'
	with serdeproperties(
		"separatorChar" = ",",
		"quoteChar"     = "\""
	)
	stored as textfile
	location '/user/cloudera/loadData'
	tblproperties("skip.header.line.count"="1");
	
load data local inpath '/home/cloudera/data/genderStatsData/Gender_StatsData.csv' overwrite into table country_gender;

--cleanse the data by stripping the country name, indicator name, and removing empty records
create table country_staging(
	country_code string,
	indicator_code string,
	Y1960 decimal(30, 15),
	Y1961 decimal(30, 15),
	Y1962 decimal(30, 15),
	Y1963 decimal(30, 15),
	Y1964 decimal(30, 15),
	Y1965 decimal(30, 15),
	Y1966 decimal(30, 15),
	Y1967 decimal(30, 15),
	Y1968 decimal(30, 15),
	Y1969 decimal(30, 15),
	Y1970 decimal(30, 15),
	Y1971 decimal(30, 15),
	Y1972 decimal(30, 15),
	Y1973 decimal(30, 15),
	Y1974 decimal(30, 15),
	Y1975 decimal(30, 15),
	Y1976 decimal(30, 15),
	Y1977 decimal(30, 15),
	Y1978 decimal(30, 15),
	Y1979 decimal(30, 15),
	Y1980 decimal(30, 15),
	Y1981 decimal(30, 15),
	Y1982 decimal(30, 15),
	Y1983 decimal(30, 15),
	Y1984 decimal(30, 15),
	Y1985 decimal(30, 15),
	Y1986 decimal(30, 15),
	Y1987 decimal(30, 15),
	Y1988 decimal(30, 15),
	Y1989 decimal(30, 15),
	Y1990 decimal(30, 15),
	Y1991 decimal(30, 15),
	Y1992 decimal(30, 15),
	Y1993 decimal(30, 15),
	Y1994 decimal(30, 15),
	Y1995 decimal(30, 15),
	Y1996 decimal(30, 15),
	Y1997 decimal(30, 15),
	Y1998 decimal(30, 15),
	Y1999 decimal(30, 15),
	Y2000 decimal(30, 15),
	Y2001 decimal(30, 15),
	Y2002 decimal(30, 15),
	Y2003 decimal(30, 15),
	Y2004 decimal(30, 15),
	Y2005 decimal(30, 15),
	Y2006 decimal(30, 15),
	Y2007 decimal(30, 15),
	Y2008 decimal(30, 15),
	Y2009 decimal(30, 15),
	Y2010 decimal(30, 15),
	Y2011 decimal(30, 15),
	Y2012 decimal(30, 15),
	Y2013 decimal(30, 15),
	Y2014 decimal(30, 15),
	Y2015 decimal(30, 15),
	Y2016 decimal(30, 15))
	row format delimited
	fields terminated by ','
	stored as textfile;

insert overwrite table country_staging
	select
		country_code,
		indicator_code,
		cast(Y1960 as decimal(30, 15)),
		cast(Y1961 as decimal(30, 15)),
		cast(Y1962 as decimal(30, 15)),
		cast(Y1963 as decimal(30, 15)),
		cast(Y1964 as decimal(30, 15)),
		cast(Y1965 as decimal(30, 15)),
		cast(Y1966 as decimal(30, 15)),
		cast(Y1967 as decimal(30, 15)),
		cast(Y1968 as decimal(30, 15)),
		cast(Y1969 as decimal(30, 15)),
		cast(Y1970 as decimal(30, 15)),
		cast(Y1971 as decimal(30, 15)),
		cast(Y1972 as decimal(30, 15)),
		cast(Y1973 as decimal(30, 15)),
		cast(Y1974 as decimal(30, 15)),
		cast(Y1975 as decimal(30, 15)),
		cast(Y1976 as decimal(30, 15)),
		cast(Y1977 as decimal(30, 15)),
		cast(Y1978 as decimal(30, 15)),
		cast(Y1979 as decimal(30, 15)),
		cast(Y1980 as decimal(30, 15)),
		cast(Y1981 as decimal(30, 15)),
		cast(Y1982 as decimal(30, 15)),
		cast(Y1983 as decimal(30, 15)),
		cast(Y1984 as decimal(30, 15)),
		cast(Y1985 as decimal(30, 15)),
		cast(Y1986 as decimal(30, 15)),
		cast(Y1987 as decimal(30, 15)),
		cast(Y1988 as decimal(30, 15)),
		cast(Y1989 as decimal(30, 15)),
		cast(Y1990 as decimal(30, 15)),
		cast(Y1991 as decimal(30, 15)),
		cast(Y1992 as decimal(30, 15)),
		cast(Y1993 as decimal(30, 15)),
		cast(Y1994 as decimal(30, 15)),
		cast(Y1995 as decimal(30, 15)),
		cast(Y1996 as decimal(30, 15)),
		cast(Y1997 as decimal(30, 15)),
		cast(Y1998 as decimal(30, 15)),
		cast(Y1999 as decimal(30, 15)),
		cast(Y2000 as decimal(30, 15)),
		cast(Y2001 as decimal(30, 15)),
		cast(Y2002 as decimal(30, 15)),
		cast(Y2003 as decimal(30, 15)),
		cast(Y2004 as decimal(30, 15)),
		cast(Y2005 as decimal(30, 15)),
		cast(Y2006 as decimal(30, 15)),
		cast(Y2007 as decimal(30, 15)),
		cast(Y2008 as decimal(30, 15)),
		cast(Y2009 as decimal(30, 15)),
		cast(Y2010 as decimal(30, 15)),
		cast(Y2011 as decimal(30, 15)),
		cast(Y2012 as decimal(30, 15)),
		cast(Y2013 as decimal(30, 15)),
		cast(Y2014 as decimal(30, 15)),
		cast(Y2015 as decimal(30, 15)),
		cast(Y2016 as decimal(30, 15))
	from country_gender
	where coalesce(	cast(Y1960 as decimal(30, 15)),
	cast(Y1961 as decimal(30, 15)),
	cast(Y1962 as decimal(30, 15)),
	cast(Y1963 as decimal(30, 15)),
	cast(Y1964 as decimal(30, 15)),
	cast(Y1965 as decimal(30, 15)),
	cast(Y1966 as decimal(30, 15)),
	cast(Y1967 as decimal(30, 15)),
	cast(Y1968 as decimal(30, 15)),
	cast(Y1969 as decimal(30, 15)),
	cast(Y1970 as decimal(30, 15)),
	cast(Y1971 as decimal(30, 15)),
	cast(Y1972 as decimal(30, 15)),
	cast(Y1973 as decimal(30, 15)),
	cast(Y1974 as decimal(30, 15)),
	cast(Y1975 as decimal(30, 15)),
	cast(Y1976 as decimal(30, 15)),
	cast(Y1977 as decimal(30, 15)),
	cast(Y1978 as decimal(30, 15)),
	cast(Y1979 as decimal(30, 15)),
	cast(Y1980 as decimal(30, 15)),
	cast(Y1981 as decimal(30, 15)),
	cast(Y1982 as decimal(30, 15)),
	cast(Y1983 as decimal(30, 15)),
	cast(Y1984 as decimal(30, 15)),
	cast(Y1985 as decimal(30, 15)),
	cast(Y1986 as decimal(30, 15)),
	cast(Y1987 as decimal(30, 15)),
	cast(Y1988 as decimal(30, 15)),
	cast(Y1989 as decimal(30, 15)),
	cast(Y1990 as decimal(30, 15)),
	cast(Y1991 as decimal(30, 15)),
	cast(Y1992 as decimal(30, 15)),
	cast(Y1993 as decimal(30, 15)),
	cast(Y1994 as decimal(30, 15)),
	cast(Y1995 as decimal(30, 15)),
	cast(Y1996 as decimal(30, 15)),
	cast(Y1997 as decimal(30, 15)),
	cast(Y1998 as decimal(30, 15)),
	cast(Y1999 as decimal(30, 15)),
	cast(Y2000 as decimal(30, 15)),
	cast(Y2001 as decimal(30, 15)),
	cast(Y2002 as decimal(30, 15)),
	cast(Y2003 as decimal(30, 15)),
	cast(Y2004 as decimal(30, 15)),
	cast(Y2005 as decimal(30, 15)),
	cast(Y2006 as decimal(30, 15)),
	cast(Y2007 as decimal(30, 15)),
	cast(Y2008 as decimal(30, 15)),
	cast(Y2009 as decimal(30, 15)),
	cast(Y2010 as decimal(30, 15)),
	cast(Y2011 as decimal(30, 15)),
	cast(Y2012 as decimal(30, 15)),
	cast(Y2013 as decimal(30, 15)),
	cast(Y2014 as decimal(30, 15)),
	cast(Y2015 as decimal(30, 15)),
	cast(Y2016 as decimal(30, 15))) is not null;

--partition the data by indicator code
set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.exec.max.dynamic.partitions=1000;
set hive.exec.max.dynamic.partitions.pernode=1000;

create table country_gender_partition(
	country_code string,
	Y1960 decimal(30, 15),
	Y1961 decimal(30, 15),
	Y1962 decimal(30, 15),
	Y1963 decimal(30, 15),
	Y1964 decimal(30, 15),
	Y1965 decimal(30, 15),
	Y1966 decimal(30, 15),
	Y1967 decimal(30, 15),
	Y1968 decimal(30, 15),
	Y1969 decimal(30, 15),
	Y1970 decimal(30, 15),
	Y1971 decimal(30, 15),
	Y1972 decimal(30, 15),
	Y1973 decimal(30, 15),
	Y1974 decimal(30, 15),
	Y1975 decimal(30, 15),
	Y1976 decimal(30, 15),
	Y1977 decimal(30, 15),
	Y1978 decimal(30, 15),
	Y1979 decimal(30, 15),
	Y1980 decimal(30, 15),
	Y1981 decimal(30, 15),
	Y1982 decimal(30, 15),
	Y1983 decimal(30, 15),
	Y1984 decimal(30, 15),
	Y1985 decimal(30, 15),
	Y1986 decimal(30, 15),
	Y1987 decimal(30, 15),
	Y1988 decimal(30, 15),
	Y1989 decimal(30, 15),
	Y1990 decimal(30, 15),
	Y1991 decimal(30, 15),
	Y1992 decimal(30, 15),
	Y1993 decimal(30, 15),
	Y1994 decimal(30, 15),
	Y1995 decimal(30, 15),
	Y1996 decimal(30, 15),
	Y1997 decimal(30, 15),
	Y1998 decimal(30, 15),
	Y1999 decimal(30, 15),
	Y2000 decimal(30, 15),
	Y2001 decimal(30, 15),
	Y2002 decimal(30, 15),
	Y2003 decimal(30, 15),
	Y2004 decimal(30, 15),
	Y2005 decimal(30, 15),
	Y2006 decimal(30, 15),
	Y2007 decimal(30, 15),
	Y2008 decimal(30, 15),
	Y2009 decimal(30, 15),
	Y2010 decimal(30, 15),
	Y2011 decimal(30, 15),
	Y2012 decimal(30, 15),
	Y2013 decimal(30, 15),
	Y2014 decimal(30, 15),
	Y2015 decimal(30, 15),
	Y2016 decimal(30, 15))
	partitioned by (indicator_code string)
	row format delimited
	fields terminated by ','
	stored as textfile;
	
insert overwrite table country_gender_partition partition(indicator_code)
	select
		country_code,
		Y1960,
		Y1961,
		Y1962,
		Y1963,
		Y1964,
		Y1965,
		Y1966,
		Y1967,
		Y1968,
		Y1969,
		Y1970,
		Y1971,
		Y1972,
		Y1973,
		Y1974,
		Y1975,
		Y1976,
		Y1977,
		Y1978,
		Y1979,
		Y1980,
		Y1981,
		Y1982,
		Y1983,
		Y1984,
		Y1985,
		Y1986,
		Y1987,
		Y1988,
		Y1989,
		Y1990,
		Y1991,
		Y1992,
		Y1993,
		Y1994,
		Y1995,
		Y1996,
		Y1997,
		Y1998,
		Y1999,
		Y2000,
		Y2001,
		Y2002,
		Y2003,
		Y2004,
		Y2005,
		Y2006,
		Y2007,
		Y2008,
		Y2009,
		Y2010,
		Y2011,
		Y2012,
		Y2013,
		Y2014,
		Y2015,
		Y2016,
		indicator_code
	from country_staging;